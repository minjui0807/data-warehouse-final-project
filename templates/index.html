<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>JOB Miner — 全方位職缺分析系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <header>
    <h1 class="brand-title style-2">
        JOB <span class="highlight">Miner</span>
    </h1>
    <nav>
      <a href="#" class="nav-link active" onclick="switchTab('market')">市場分析</a>
      <a href="#" class="nav-link" onclick="switchTab('trend')">職缺趨勢比較</a>
      <a href="#" class="nav-link" onclick="switchTab('history'); loadHistoryList();">歷史紀錄查詢</a>
    </nav>
  </header>

  <div id="view-market" class="tab-content active-tab">
      <section class="hero">
        <h2>市場洞察 &<br>職缺機會發掘</h2>
        <p>深度掃描 104 與 1111 人力銀行資料庫，<br>
            即時解析薪資結構與職缺分佈趨勢。</p>
        
        <div class="search-container">
          <div class="input-group" style="flex: 2;">
            <input type="text" id="keyword" class="search-input" placeholder="請輸入職缺關鍵字 (例如: Python 工程師)" value="python">
          </div>
          <div class="input-group" style="flex: 1;">
            <input type="text" id="max_num" class="search-input" placeholder="各平台抓取筆數" value="200">
          </div>
          
          <button id="btn-search" type="button" class="btn-search" onclick="startScraping()">開始分析職缺</button>
        </div>
        
        <div id="loader" class="loader">
            正在搜尋各平台資料<span class="dot-animation"></span>
        </div>
      </section>

      <div id="results-area">
        <div class="actions-bar">
            <button class="btn-action" onclick="exportCSV()">匯出完整CSV檔</button>
            <button class="btn-action" onclick="saveAllToDB()">匯出完整資料庫(db檔)</button>
        </div>

        <section class="stats-grid">
            <div class="stat-card">
                <span class="stat-label">總職缺數</span>
                <span class="stat-value" id="stat-total">0</span>
                <span class="stat-trend">已分析職缺</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">平均月薪</span>
                <span class="stat-value" id="stat-salary">0</span>
                <span class="stat-trend">新台幣 / 月</span>
            </div>
            <div class="stat-card">
                <div class="card-title">平台資料來源</div>
                <div class="platform-dual-container flex-grow-content">
                    <div class="platform-box">
                        <span class="stat-value" id="count_104">0</span>
                        <span class="stat-trend color-104">104 人力銀行</span>
                    </div>
                    <div class="vertical-line"></div>
                    <div class="platform-box">
                        <span class="stat-value" id="count_1111">0</span>
                        <span class="stat-trend color-1111">1111 人力銀行</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="chart-section">
            <div>
                <h3 class="section-title">薪資分佈區間</h3>
                <div class="chart-container" id="chart-salary">
                    <span style="color:#444">等待分析...</span>
                </div>
            </div>
            <div>
                <h3 class="section-title">職缺地區分佈</h3>
                <div class="chart-container" id="chart-location">
                    <span style="color:#444">等待分析...</span>
                </div>
            </div>
        </section>

        <section class="jobs-section">
            <h3 class="section-title">精選職缺列表</h3>
            <div class="filter-bar">
                <div class="filter-group">
                    <label>地區:</label>
                    <select id="filter-city" onchange="applyFilters()" style="font-size: 18px;">
                        <option value="all">所有縣市</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>平台:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="cb-104" value="104" checked onchange="applyFilters()"> 104</label>
                        <label><input type="checkbox" id="cb-1111" value="1111" checked onchange="applyFilters()"> 1111</label>
                    </div>
                </div>
                <div class="filter-group">
                <label>薪資類型:</label>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <select id="salary-type" class="form-select">
                        <option value="all">所有類型</option>
                        <option value="月薪">月薪</option>
                        <option value="年薪">年薪</option>
                        <option value="時薪">時薪</option>
                        <option value="日薪">日薪</option>
                        <option value="論件">論件計酬</option>
                        <option value="面議">面議</option>
                    </select>

                    <span id="salary-inputs-group" style="display: flex; gap: 5px; align-items: center;">
                        <input type="number" id="min-salary-input" placeholder="最低" class="form-input" style="width: 80px;">
                        <span>~</span>
                        <input type="number" id="max-salary-input" placeholder="最高" class="form-input" style="width: 80px;">
                    </span>
                </div>
            </div>
                <div class="filter-group">
                      <button onclick="exportFilteredCSV()" style="font-size:20px; padding: 4px 8px; cursor: pointer; background: #333; color: white; border: 1px solid #555; border-radius: 4px; margin-right: 5px;">匯出 CSV檔案</button>
                      <button onclick="saveFilteredToDB()" style="font-size:20px; padding: 4px 8px; cursor: pointer; background: #333; color: white; border: 1px solid #555; border-radius: 4px;">匯出資料庫 (.db檔)</button>
                </div>
                <div class="filter-group ml-auto"> 
                    <label>排序:</label>
                    <select id="sort-by" onchange="applyFilters()">
                        <option value="default">預設排序</option>
                        <option value="salary_desc">薪資 (高 → 低)</option>
                        <option value="salary_asc">薪資 (低 → 高)</option>
                        <option value="date_desc">更新日期 (新 → 舊)</option>
                        <option value="company">公司名稱 (A → Z)</option>
                    </select>
                </div>
            </div>
            
            <div class="jobs-grid" id="jobs-container"></div>

            <div class="btn-load-more-container">
                <button id="btn-load-more" class="btn-load-more" onclick="loadMoreJobs()">
                    查看更多職缺 (顯示 <span id="shown-count">0</span> / <span id="total-count">0</span>)
                </button>
            </div>
        </section>
      </div>
  </div>

  <div id="view-trend" class="tab-content">
      <section class="hero">
        <h2>自訂職缺市場趨勢比較</h2>
        <p>輸入您想比較的職缺關鍵字，系統將快速掃描 104 與 1111 的職缺總量。</p>
        
        <div style="max-width: 1000px; margin-top: 40px;">
            <div id="keywords-container" class="keywords-grid"></div>
            
            <div style="display: flex; gap: 16px;">
                <button class="btn-add" onclick="addKeywordCard('')" style="flex:1;">
                    <span style="font-size:18px; margin-right:5px;">+</span> 新增比較項目
                </button>
                <button id="btn-stats" type="button" class="btn-search" style="flex:2;" onclick="startTrendAnalysis()">
                    開始統計分析
                </button>
            </div>
        </div>
        
        <div id="loader-stats" class="loader">
          正在連結各大平台取得數據<span class="dot-animation"></span>
        </div>
      </section>

      <div id="stats-results-area">
        <section class="chart-section" style="grid-template-columns: 1fr;">
            <div>
                <h3 class="section-title">職缺數量分析圖表</h3>
                <div class="chart-container" id="chart-stats" style="min-height: 500px;">
                    <span style="color:#444">等待分析...</span>
                </div>
            </div>
        </section>

        <section class="stats-grid" id="text-stats-area" style="margin-top: 20px; display:none;">
            <div class="stat-card" style="width: 100%; height: auto;">
                <span class="stat-label">詳細數據 (關鍵字 : 總職缺數)</span>
                <div id="stats-list" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 15px; color: white;"></div>
            </div>
        </section>
      </div>
  </div>

  <!-- 歷史資料庫 -->
  <div id="view-history" class="tab-content">
    
    <div id="history-list-view">
        <section class="hero" style="min-height: auto; padding: 40px 0;">
            <h2>伺服器歷史紀錄庫</h2>
            <p style="color: #888;">點擊卡片檢視當時的分析數據</p>
        </section>
        <div id="history-list-container" class="history-grid"></div>
        <!-- 如果無資料 -->
        <div id="history-empty-state" class="empty-state-container" style="display: none;">
          <div class="empty-icon">
              <i class="fas fa-folder-open"></i>
          </div>
          <h3>目前尚無歷史紀錄</h3>
          <p>您尚未儲存任何職缺分析資料。<br>請前往市場分析進行搜尋，系統將自動為您建立檔案。</p>
          
          <button onclick="switchTab('market')" class="btn-redirect">
              <i class="fas fa-search"></i> 前往市場分析
          </button>
      </div>

    </div>
    <div id="history-detail-view" style="display: none;">
        <div class="history-header-container">
            <div class="history-title-center">
                <h2 id="h-keyword-title">職缺名稱</h2>
                <p id="h-save-time" class="save-time-badge"></p>
                
                <div class="header-action-row">
                    <button onclick="backToHistoryList()" class="btn-back-modern">
                        <i class="fas fa-arrow-left"></i> 返回紀錄列表
                    </button>
                </div>
            </div>
        </div>
        

        <section class="stats-grid">
            <div class="stat-card">
                <span class="stat-label">總職缺數</span>
                <span class="stat-value" id="h-total-jobs">0</span>
                <span class="stat-trend">歷史存檔數據</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">平均月薪</span>
                <span class="stat-value" id="h-avg-salary">0</span>
                <span class="stat-trend">新台幣 / 月</span>
            </div>
            <div class="stat-card">
                <div class="card-title">平台資料來源</div>
                <div class="platform-dual-container flex-grow-content">
                    <div class="platform-box">
                        <span class="stat-value" id="h-count-104">0</span>
                        <span class="stat-trend color-104">104 人力銀行</span>
                    </div>
                    <div class="vertical-line"></div>
                    <div class="platform-box">
                        <span class="stat-value" id="h-count-1111">0</span>
                        <span class="stat-trend color-1111">1111 人力銀行</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="chart-section">
            <div>
                <h3 class="section-title">薪資分佈區間</h3>
                <div class="chart-container" id="h-chart-salary"></div>
            </div>
            <div>
                <h3 class="section-title">職缺地區分佈</h3>
                <div class="chart-container" id="h-chart-location"></div>
            </div>
        </section>

        <section class="jobs-section">
            <h3 class="section-title">存檔職缺明細</h3>
            
            <div class="filter-bar">
                <div class="filter-group">
                    <label>地區:</label>
                    <select id="h-filter-city" onchange="applyHistoryFilters()" style="font-size: 20px;">
                        <option value="all">所有縣市</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>平台:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="h-cb-104" value="104" checked onchange="applyHistoryFilters()"> 104</label>
                        <label><input type="checkbox" id="h-cb-1111" value="1111" checked onchange="applyHistoryFilters()"> 1111</label>
                    </div>
                </div>
                <div class="filter-group">
                    <label>薪資類型:</label>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <select id="h-salary-type" class="form-select">
                            <option value="all">所有類型</option>
                            <option value="月薪">月薪</option>
                            <option value="年薪">年薪</option>
                            <option value="時薪">時薪</option>
                            <option value="日薪">日薪</option>
                            <option value="論件">論件計酬</option>
                            <option value="面議">面議</option>
                        </select>

                        <div id="h-salary-inputs-group" style="display: flex; gap: 5px; align-items: center;">
                            <input type="number" id="h-min-salary-input" placeholder="最低" class="form-input" style="width: 80px;">
                            <span>~</span>
                            <input type="number" id="h-max-salary-input" placeholder="最高" class="form-input" style="width: 80px;">
                        </div>

                    </div>
                </div>
                <div class="filter-group">
                      <button onclick="exportHistoryCSV()" style="font-size:20px; padding: 4px 8px; cursor: pointer; background: #333; color: white; border: 1px solid #555; border-radius: 4px; margin-right: 5px;">匯出 CSV</button>
                      <button onclick="downloadHistoryDB()" style="font-size:20px; padding: 4px 8px; cursor: pointer; background: #333; color: white; border: 1px solid #555; border-radius: 4px; margin-right: 5px;">匯出資料庫</button>
                </div>
                <div class="filter-group ml-auto"> 
                    <label>排序:</label>
                    <select id="h-sort-by" onchange="applyHistoryFilters()">
                        <option value="default">預設排序</option>
                        <option value="salary_desc">薪資 (高 → 低)</option>
                        <option value="salary_asc">薪資 (低 → 高)</option>
                        <option value="date_desc">更新日期 (新 → 舊)</option>
                        <option value="company">公司名稱 (A → Z)</option>
                    </select>
                </div>
            </div>

            <div id="h-jobs-list" class="jobs-grid"></div>

            <div class="btn-load-more-container" id="h-load-more-container" style="display:none; margin-top:20px;">
                <button id="h-btn-load-more" class="btn-load-more" onclick="loadMoreHistoryJobs()">
                    查看更多存檔職缺 (顯示 <span id="h-shown-count">0</span> / <span id="h-total-count">0</span>)
                </button>
            </div>
        </section>

    </div>
  </div>

    <button id="scroll-to-top" title="回到頂端">
        <i class="fas fa-chevron-up"></i>
    </button>

  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>